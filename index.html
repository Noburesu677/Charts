<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AnomicValue</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- néon + étoilé inline -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    #stars,#stars2{position:fixed;top:0;left:0;width:200%;height:200%;background:url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/starfield.png')repeat;animation:drift 200s linear infinite;z-index:-2;}
    #stars2{opacity:.2;animation-duration:300s;}
    @keyframes drift{from{transform:translate(0,0)}to{transform:translate(-50%,-50%)}}
    body{font-family:'Orbitron',sans-serif;background:#000;color:#eee;display:flex;flex-direction:column;min-height:100vh;}
    header,footer{text-align:center;padding:1rem;background:rgba(0,0,0,.6);}
    #logo{font-size:3rem;color:#0ff;text-shadow:0 0 4px #0ff,0 0 8px #0ff,0 0 12px #0ff,0 0 16px #0ff;}
    main{flex:1;display:flex;justify-content:center;align-items:center;padding:2rem;}
    #chart-box{position:relative;width:80vmin;height:80vmin;max-width:700px;max-height:700px;background:#111;border:4px solid #0ff;border-radius:12px;box-shadow:0 0 30px rgba(0,255,255,.6),inset 0 0 15px rgba(0,255,255,.8);overflow:hidden;}
    #chart-box canvas{width:100% !important;height:100% !important;}
    #actions{position:absolute;top:10px;right:10px;display:flex;gap:.5rem;}
    #actions button{background:rgba(0,255,255,.2);border:none;padding:.5rem;font-size:1.3rem;color:#0ff;border-radius:6px;cursor:pointer;transition:background .2s;}
    #actions button:hover{background:rgba(0,255,255,.4);}
    #controls{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:.4rem;}
    #controls button{background:rgba(0,255,255,.2);border:2px solid transparent;padding:.5rem .8rem;font-size:.9rem;color:#0ff;border-radius:4px;cursor:pointer;transition:all .2s;}
    #controls button.active,#controls button:hover{background:rgba(0,255,255,.4);border-color:#0ff;transform:scale(1.1);}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
</head>
<body>
  <div id="stars"></div><div id="stars2"></div>
  <header><h1 id="logo">AnomicValue</h1></header>
  <main>
    <div id="chart-box">
      <canvas id="chart"></canvas>
      <div id="actions">
        <button id="refresh" title="Refresh">⚡</button>
        <button id="fullscreen" title="Fullscreen">⤢</button>
      </div>
      <div id="controls">
        <button data-range="all" class="active">All</button>
        <button data-range="365">1Y</button>
        <button data-range="90">3M</button>
        <button data-range="30">1M</button>
        <button data-range="7">1W</button>
        <button data-range="1">1D</button>
      </div>
    </div>
  </main>
  <footer>© 2025 AnomicValue</footer>

  <script>
    const APP_SCRIPT_URL =
      'https://script.google.com/macros/s/AKfycbzfPNzTWYNvbCDjnhsGmujnMo7rZLy8_reOkKmZbbK8ec5b_I1DRuD_S--PyAVMCPEjjg/exec';
    const params = new URLSearchParams(location.search);
    const itemName = params.get('name');

    if (!itemName) {
      document.body.innerHTML =
        '<p style="color:#f55;text-align:center;padding:2rem">' +
        '❌ Missing <code>?name=ItemName</code>' +
        '</p>';
    } else {
      let chart, dataStore, currentRange = 'all';
      const ctx = document.getElementById('chart').getContext('2d');

      function draw(range) {
        currentRange = range;
        let subset = dataStore;
        if (range!=='all') {
          const cutoffIndex = dataStore.length - range;
          subset = dataStore.slice(cutoffIndex<0?0:cutoffIndex);
        }
        const labels = subset.map(p=>p.t.toString());
        const vals   = subset.map(p=>p.v);
        const cfg = {
          type:'line',
          data:{ labels, datasets:[{ label:itemName, data:vals,
            borderColor:'#0ff', backgroundColor:'rgba(0,255,255,0.1)',
            pointRadius: (ctx) => {
              const i=ctx.dataIndex;
              return i>0 && ctx.dataset.data[i]!==ctx.dataset.data[i-1]?5:0;
            }
          }]},
          options:{ responsive:true, maintainAspectRatio:false }
        };
        if (chart) chart.destroy();
        chart = new Chart(ctx, cfg);
        document.querySelectorAll('#controls button').forEach(b=>
          b.classList.toggle('active', b.dataset.range===range)
        );
      }

      function load() {
        fetch(`${APP_SCRIPT_URL}?name=${encodeURIComponent(itemName)}`)
          .then(r=>r.ok?r.json():Promise.reject(r.statusText))
          .then(data=>{
            dataStore = data;
            draw(currentRange);
          })
          .catch(e=>{
            document.body.innerHTML =
              `<p style="color:#f55;text-align:center;padding:2rem">
                ❌ Error: ${e}
              </p>`;
          });
      }

      document.getElementById('controls').addEventListener('click', e=>{
        const b=e.target.closest('button');
        if (b) draw(b.dataset.range);
      });
      document.getElementById('refresh')
        .addEventListener('click',load);
      document.getElementById('fullscreen')
        .addEventListener('click',()=>{
          const el=document.getElementById('chart-box');
          document.fullscreenElement?document.exitFullscreen():el.requestFullscreen();
        });

      load();
    }
  </script>
</body>
</html>
