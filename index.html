<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AnomicValue Charts</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="assets/style.css?v=4" />
</head>
<body>
  <canvas id="duneCanvas"></canvas>

  <header class="fade-in-down">
    <div class="logo">
      <img src="assets/logo.png" alt="AnomicValue" />
      <h1>AnomicValue Charts</h1>
    </div>
    <nav>
      <a href="#all" style="--i:0">All</a>
      <a href="#1d"  style="--i:1">1D</a>
      <a href="#1w"  style="--i:2">1W</a>
      <a href="#1m"  style="--i:3">1M</a>
      <a href="#1y"  style="--i:4">1Y</a>
    </nav>
  </header>

  <main>
    <div id="chartContainer" class="fade-in-up">
      <div id="loadingOverlay"><div class="spinner"></div></div>
      <canvas id="miniChart" width="200" height="50"></canvas>
      <div class="chart-controls">
        <button id="contrastBtn" aria-label="High Contrast"></button>
        <button id="fullscreenBtn" aria-label="Fullscreen"></button>
      </div>
      <canvas id="mainChart"></canvas>
    </div>
  </main>

  <footer class="fade-in-up">
    <p>Â© 2025 AnomicValue. All rights reserved.</p>
  </footer>

  <script>
    const APP_SCRIPT_URL =
      'https://script.google.com/macros/s/AKfycbzyaaDiRnXsKyx5-CwD_XFzPoCswdJoU_yfNLdmvanYPrgrUg_CjLDs8KlIHOLevsiSTg/exec';
    const mainCtx = document.getElementById('mainChart').getContext('2d');
    const miniCtx = document.getElementById('miniChart').getContext('2d');
    let mainChart, miniChart;

    // Dunes animation
    const canvas = document.getElementById('duneCanvas'),
          ctx    = canvas.getContext('2d');
    let w, h, t = 0;
    function resizeCanvas() {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    (function drawDunes(){
      ctx.clearRect(0,0,w,h);
      for(let i=0;i<3;i++){
        const y = h*(0.6 + i*0.1),
              amp = 20 + i*5,
              speed = 0.5 + i*0.2;
        ctx.fillStyle = `rgba(235,200,120,${0.2 + i*0.1})`;
        ctx.beginPath();
        ctx.moveTo(0, y);
        for(let x=0; x<=w; x+=20){
          ctx.lineTo(x, y + Math.sin(x*0.02 + t*speed)*amp);
        }
        ctx.lineTo(w, h);
        ctx.lineTo(0, h);
        ctx.closePath();
        ctx.fill();
      }
      t += 0.01;
      requestAnimationFrame(drawDunes);
    })();

    async function fetchData(item) {
      const res = await fetch(
        `${APP_SCRIPT_URL}?name=${encodeURIComponent(item)}`
      );
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if(!Array.isArray(data) || data.length === 0)
        throw new Error('No data');
      return data;
    }

    async function loadChart(mode) {
      const item =
        new URLSearchParams(location.search).get('item');
      if(!item) throw new Error('Missing ?item');
      const raw = await fetchData(item);
      const grouped = {};
      raw.forEach(p => {
        const d = new Date(p.t * 1000),
              lbl = `${String(d.getDate()).padStart(2,'0')}/${
                      String(d.getMonth()+1).padStart(2,'0')}`;
        grouped[lbl] = p.v;
      });
      return {
        labels: Object.keys(grouped),
        values: Object.values(grouped)
      };
    }

    async function updateCharts(mode) {
      document.getElementById('loadingOverlay').style.display = 'flex';
      try {
        const { labels, values } = await loadChart(mode);

        // Main Chart
        if(mainChart){
          mainChart.data.labels = labels;
          mainChart.data.datasets[0].data = values;
          mainChart.update();
        } else {
          mainChart = new Chart(mainCtx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'Price',
                data: values,
                borderColor: 'red',
                backgroundColor: 'transparent',
                pointRadius: 5
              }]
            },
            options: {
              responsive: true,
              interaction: { mode: 'nearest', intersect: true },
              plugins: { tooltip: { enabled: true, backgroundColor: '#000' } },
              animation: { duration: 800 },
              scales: {
                x: { ticks: { color: '#fff' }, grid: { color: '#444' } },
                y: { ticks: { color: '#fff' }, grid: { color: '#444' } }
              }
            }
          });
        }

        // Mini Sparkline
        if(miniChart){
          miniChart.data.labels = labels;
          miniChart.data.datasets[0].data = values;
          miniChart.update();
        } else {
          miniChart = new Chart(miniCtx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                data: values,
                borderColor: '#ff7700',
                backgroundColor: 'transparent',
                pointRadius: 0
              }]
            },
            options: {
              responsive: true,
              animation: { duration: 500 },
              plugins: { legend: { display: false } },
              scales: { x: { display: false }, y: { display: false } }
            }
          });
        }
      } catch(e){
        console.error(e);
      } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    }

    // Tabs
    document.querySelectorAll('nav a').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        document.querySelectorAll('nav a')
          .forEach(n => n.classList.remove('active'));
        a.classList.add('active');
        updateCharts(a.getAttribute('href').slice(1));
      });
    });
    window.addEventListener('DOMContentLoaded', () => {
      document.querySelector('nav a[href="#all"]').click();
    });

    // Fullscreen toggle
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      const el = document.getElementById('chartContainer');
      if(document.fullscreenElement) document.exitFullscreen();
      else el.requestFullscreen();
    });

    // High Contrast toggle
    document.getElementById('contrastBtn').addEventListener('click', () => {
      document.body.classList.toggle('high-contrast');
    });
  </script>
</body>
</html>
