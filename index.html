<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Historique • AnomicValue</title>
  <style>
    /* Reset & thème sombre */
    * { box-sizing: border-box; margin:0; padding:0; }
    html, body { height: 100%; background: #141517; color: #DDD; font-family: "Segoe UI", sans-serif; }
    #container { display: flex; flex-direction: column; height: 100%; }

    /* Contrôles */
    #controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 6px;
      padding: 10px;
      background: #1E1F22;
      border-bottom: 1px solid #333;
    }
    #controls button {
      background: #2A2C31;
      border: 1px solid #444;
      border-radius: 4px;
      color: #BBB;
      padding: 6px 14px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s, color 0.2s;
    }
    #controls button:hover {
      background: #3A3D44;
      color: #FFF;
    }
    #controls button.active {
      background: #5865F2;
      border-color: #4752C4;
      color: #FFF;
    }

    /* Chart principal et overview */
    #chart, #overview { width: 100%; }
    #chart { flex: 1; }                      /* prend tout l’espace restant */
    #overview { height: 100px; }             /* hauteur fixe pour l’aperçu */
    #message {
      text-align: center;
      padding: 12px;
      background: #1E1F22;
      border-top: 1px solid #333;
      font-size: 0.95em;
    }

    /* Footer discret */
    footer {
      text-align: right;
      padding: 4px 12px;
      font-size: 0.75em;
      color: #555;
      background: #1E1F22;
      border-top: 1px solid #333;
    }
    footer a { color: #555; text-decoration: none; }
    footer a:hover { color: #AAA; }
  </style>

  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>

<body>
  <div id="container">
    <div id="controls">
      <button data-range="1">1d</button>
      <button data-range="3">3d</button>
      <button data-range="7">1w</button>
      <button data-range="30">1m</button>
      <button data-range="90">3m</button>
      <button data-range="365">1y</button>
      <button data-range="0" class="active">All</button>
    </div>

    <div id="chart"></div>
    <div id="overview"></div>
    <p id="message"></p>

    <footer>
      <a href="https://discord.gg/jM2AQXtZ" target="_blank">Join AnomicValue Discord</a>
    </footer>
  </div>

  <script>
    // 1) Récupère l'item dans l'URL
    const params = new URLSearchParams(location.search);
    const item   = params.get('item') || params.get('name');
    const msg    = document.getElementById('message');
    if (!item) {
      msg.textContent = '⚠️ Merci de passer ?item=NomDeTonItem';
    } else {
      // 2) Injecte via JSONP
      const s = document.createElement('script');
      s.src = 'https://script.google.com/macros/s/AKfycbyX-_XhaZi2M05lP3B67oIxsg9j8oTC0t7VvYHwALlKYCe96ceowiUiwiX6chRwzEwY0Q/exec'
            + '?name=' + encodeURIComponent(item)
            + '&callback=init';
      document.head.appendChild(s);
    }

    let fullData = [], mainChart, overviewChart, mainSeries, overviewSeries;

    // 3) Callback JSONP
    function init(data) {
      if (data.error) {
        msg.textContent = data.error;
        return;
      }
      msg.textContent = '';

      // Formatte les points [ { time, value } ]
      fullData = data.map(pt => ({
        time: new Date(pt.t*1000).toISOString().split('T')[0],
        value: pt.v
      }));

      // Chart principal
      mainChart = LightweightCharts.createChart(document.getElementById('chart'), {
        layout: { backgroundColor:'#141517', textColor:'#DDD' },
        grid:   { vertLines:{color:'#2A2B2F'}, horzLines:{color:'#2A2B2F'} },
        rightPriceScale: { borderColor:'#333' },
        timeScale: { borderColor:'#333', timeVisible:true }
      });
      mainSeries = mainChart.addLineSeries({ color:'#1FB6FF', lineWidth:2 });
      mainSeries.setData(fullData);

      // Aperçu (overview)
      overviewChart = LightweightCharts.createChart(document.getElementById('overview'), {
        layout: { backgroundColor:'#141517' },
        grid:   { vertLines:{color:'#2A2B2F'}, horzLines:{color:'#2A2B2F'} },
        handleScroll: false, handleScale: false,
        timeScale: { visible:false, borderColor:'#333' },
        rightPriceScale: { visible:false }
      });
      overviewSeries = overviewChart.addAreaSeries({
        topColor: 'rgba(31,182,255,0.5)',
        bottomColor: 'rgba(31,182,255,0.0)',
        lineColor: 'rgba(31,182,255,1)'
      });
      overviewSeries.setData(fullData);

      // Synchro des plages
      mainChart.timeScale().subscribeVisibleTimeRangeChange(range => {
        overviewChart.timeScale().setVisibleRange(range);
      });
    }

    // 4) Boutons de zoom
    document.getElementById('controls').addEventListener('click', e => {
      if (e.target.tagName !== 'BUTTON' || !mainChart) return;
      document.querySelectorAll('#controls button').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');

      const days = Number(e.target.dataset.range);
      if (days === 0) {
        mainChart.timeScale().fitContent();
      } else {
        const vr = mainChart.timeScale().getVisibleRange();
        const to = vr.to;
        mainChart.timeScale().setVisibleRange({ from: to - days*24*3600, to });
      }
    });

    // 5) Resize auto
    window.addEventListener('resize', () => {
      const w1 = document.getElementById('chart').clientWidth;
      const w2 = document.getElementById('overview').clientWidth;
      mainChart.applyOptions({ width: w1 });
      overviewChart.applyOptions({ width: w2 });
    });
  </script>
</body>
</html>
