<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AnomicValue Charts</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <canvas id="duneCanvas"></canvas>

  <header>
    <div class="logo">
      <img src="assets/logo.png" alt="AnomicValue" />
      <h1>AnomicValue Charts</h1>
    </div>
    <nav>
      <a href="#all">All</a>
      <a href="#1d">1D</a>
      <a href="#1w">1W</a>
      <a href="#1m">1M</a>
      <a href="#1y">1Y</a>
    </nav>
  </header>

  <main>
    <div id="chartContainer">
      <img id="chartImg" src="" alt="Price History Chart" />
    </div>
  </main>

  <footer>
    <p>© 2025 AnomicValue. All rights reserved.</p>
  </footer>

  <script>
    const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzyaaDiRnXsKyx5-CwD_XFzPoCswdJoU_yfNLdmvanYPrgrUg_CjLDs8KlIHOLevsiSTg/exec';

    // Anim dunes (idem avant)…
    const canvas = document.getElementById('duneCanvas');
    const ctx = canvas.getContext('2d');
    let w, h, t = 0;
    function resize() {
      w = canvas.width = innerWidth;
      h = canvas.height = innerHeight;
    }
    onresize = resize;
    resize();
    (function draw() {
      ctx.clearRect(0,0,w,h);
      for (let i=0;i<3;i++){
        const y = h*(0.6+i*0.1),
              amp = 20 + i*5,
              speed = 0.5 + i*0.2;
        ctx.fillStyle = `rgba(235,200,120,${0.2+i*0.1})`;
        ctx.beginPath();
        ctx.moveTo(0,y);
        for(let x=0;x<=w;x+=20){
          ctx.lineTo(x, y + Math.sin(x*0.02 + t*speed)*amp);
        }
        ctx.lineTo(w,h);
        ctx.lineTo(0,h);
        ctx.closePath();
        ctx.fill();
      }
      t += 0.01;
      requestAnimationFrame(draw);
    })();


    async function loadChart(mode) {
      // extrait le paramètre item de l'URL
      const params = new URLSearchParams(location.search);
      const item = params.get('item');
      if (!item) throw new Error('Pas de paramètre :item');

      // récupère le JSON depuis ton Apps Script
      const resp = await fetch(`${APP_SCRIPT_URL}?name=${encodeURIComponent(item)}`);
      if (!resp.ok) throw new Error(`Erreur : ${resp.status}`);
      const data = await resp.json();
      if (!Array.isArray(data) || data.length===0) {
        throw new Error('Pas de données');
      }

      // regroupe par date
      const grouped = {};
      data.forEach(p => {
        const d = new Date(p.t*1000);
        const lbl = String(d.getDate()).padStart(2,'0')+'/'
                  + String(d.getMonth()+1).padStart(2,'0');
        grouped[lbl] = p.v;
      });
      const labels = Object.keys(grouped);
      const values = Object.values(grouped);

      // monte la config QuickChart
      const cfg = {
        type: 'line',
        data: { labels, datasets: [{
          label: item,
          data: values,
          borderColor: 'red',
          backgroundColor: 'transparent',
          pointRadius: 3,
          tension: 0.3
        }]},
        options: {
          plugins: { legend: { labels: { color: 'white', font: { size: 14 } } } },
          scales: {
            x: { ticks: { color: 'white' }, grid: { color: 'gray' } },
            y: { ticks: { color: 'white' }, grid: { color: 'gray' } }
          },
          layout: { padding: 16 },
          backgroundColor: 'black'
        }
      };

      return 'https://quickchart.io/chart?c='
           + encodeURIComponent(JSON.stringify(cfg))
           + '&width=700&height=400';
    }

    // gestion des onglets
    document.querySelectorAll('nav a').forEach(a=>{
      a.onclick = async e=>{
        e.preventDefault();
        document.querySelectorAll('nav a').forEach(n=>n.classList.remove('active'));
        a.classList.add('active');
        try {
          const url = await loadChart(a.getAttribute('href').slice(1));
          document.getElementById('chartImg').src = url;
        } catch (err) {
          console.error(err);
          document.getElementById('chartImg').alt = err.message;
        }
      };
    });

    // init au chargement
    window.addEventListener('DOMContentLoaded', ()=>{
      document.querySelector('nav a[href="#all"]').click();
    });
  </script>
</body>
</html>
