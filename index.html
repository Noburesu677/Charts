<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Historique AnomicValue</title>
  <style>
    html, body { margin:0; padding:0; background:#1e1e1e; color:#fff; height:100%; }
    #controls { display:flex; justify-content:center; flex-wrap:wrap; gap:4px; background:#2f3136; padding:8px; }
    #controls button {
      background:#444; border:none; color:#ddd; padding:6px 12px; cursor:pointer;
    }
    #controls button.active { background:#5865f2; color:#fff; }
    #chart { width:100%; height:calc(100% - 160px); }     /* prend la hauteur restante */
    #overview { width:100%; height:100px; }
    #message { text-align:center; padding:10px; }
  </style>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <div id="controls">
    <button data-range="1">1d</button>
    <button data-range="7">1w</button>
    <button data-range="30">1m</button>
    <button data-range="90">3m</button>
    <button data-range="365">1y</button>
    <button data-range="0" class="active">All</button>
  </div>
  <div id="chart"></div>
  <div id="overview"></div>
  <p id="message"></p>

  <script>
    const params = new URLSearchParams(location.search);
    const item = params.get('item') || params.get('name');
    if(!item) {
      document.getElementById('message').textContent = '⚠️ Passe ?item=NomDeTonItem';
    } else {
      // injecte le JSONP
      const s = document.createElement('script');
      s.src = 'https://script.google.com/macros/s/AKfycbyX-_XhaZi2M05lP3B67oIxsg9j8oTC0t7VvYHwALlKYCe96ceowiUiwiX6chRwzEwY0Q/exec'
            + '?name=' + encodeURIComponent(item)
            + '&callback=init';
      document.head.appendChild(s);
    }

    let fullData = [], mainChart, overviewChart, mainSeries, overviewSeries;

    function init(data) {
      console.log('Données reçues :', data);
      if (data.error) {
        document.getElementById('message').textContent = data.error;
        return;
      }
      document.getElementById('message').textContent = '';  // efface le message

      // formate les données pour LightweightCharts
      fullData = data.map(pt => ({
        time: new Date(pt.t*1000).toISOString().split('T')[0],
        value: pt.v
      }));

      // chart principal
      mainChart = LightweightCharts.createChart(document.getElementById('chart'), {
        layout: { backgroundColor:'#1e1e1e', textColor:'#fff' },
        grid: { vertLines:{color:'#444'}, horzLines:{color:'#444'} },
        rightPriceScale: { borderColor:'#666' },
        timeScale: { borderColor:'#666', timeVisible:true }
      });
      mainSeries = mainChart.addLineSeries({ color:'#00bcd4', lineWidth:2 });
      mainSeries.setData(fullData);

      // overview
      overviewChart = LightweightCharts.createChart(document.getElementById('overview'), {
        layout: { backgroundColor:'#1e1e1e', textColor:'#888' },
        grid: { vertLines:{color:'#333'}, horzLines:{color:'#333'} },
        handleScroll: false, handleScale: false,
        timeScale: { visible: false, borderColor:'#666' },
        rightPriceScale: { visible: false }
      });
      overviewSeries = overviewChart.addAreaSeries({
        topColor: 'rgba(0,188,212,0.5)',
        bottomColor: 'rgba(0,188,212,0.0)',
        lineColor: 'rgba(0,188,212,1)'
      });
      overviewSeries.setData(fullData);

      // synchro
      mainChart.timeScale().subscribeVisibleTimeRangeChange(range => {
        overviewChart.timeScale().setVisibleRange(range);
      });
    }

    // boutons de zoom
    document.getElementById('controls').addEventListener('click', e=>{
      if(e.target.tagName!=='BUTTON' || !mainChart) return;
      document.querySelectorAll('#controls button').forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      const days = Number(e.target.dataset.range);
      if(days===0) return mainChart.timeScale().fitContent();
      const vr = mainChart.timeScale().getVisibleRange();
      const to = vr.to;
      mainChart.timeScale().setVisibleRange({ from: to - days*24*3600, to });
    });

    // resize automatique
    window.addEventListener('resize', ()=>{
      if(mainChart) mainChart.applyOptions({ width: document.getElementById('chart').clientWidth });
      if(overviewChart) overviewChart.applyOptions({ width: document.getElementById('overview').clientWidth });
    });
  </script>
</body>
</html>
