<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Historique AnomicValue</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: #141517; color: #DDD; font-family: sans-serif; }
    #container { display: flex; flex-direction: column; height: 100%; }

    /* Bar de contr√¥les */
    #controls {
      display: flex; justify-content: center; gap: 8px;
      background: #1E1F22; padding: 10px; border-bottom: 1px solid #333;
    }
    #controls button {
      background: #2A2C31; border: 1px solid #444; border-radius: 4px;
      color: #BBB; padding: 6px 12px; cursor: pointer; transition: 0.2s;
    }
    #controls button.active { background: #5865F2; color: #fff; }
    #controls button:hover { background: #3A3D44; color: #fff; }

    /* Conteneur du canvas */
    #chart-container {
      flex: 1;            /* prend tout l‚Äôespace vertical restant */
      padding: 10px;
      background: #1E1F22; /* visible si plugin ne s‚Äôapplique pas */
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    footer {
      text-align: right; font-size: 0.75em;
      padding: 6px 12px; background: #1E1F22; border-top: 1px solid #333;
    }
    footer a { color: #555; text-decoration: none; }
    footer a:hover { color: #AAA; }
  </style>

  <!-- Chart.js + moment adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@3"></script>
</head>

<body>
  <div id="container">
    <div id="controls">
      <button data-range="1">1d</button>
      <button data-range="3">3d</button>
      <button data-range="7">1w</button>
      <button data-range="30">1m</button>
      <button data-range="90">3m</button>
      <button data-range="365">1y</button>
      <button data-range="0" class="active">All</button>
    </div>

    <div id="chart-container">
      <canvas id="chart"></canvas>
    </div>

    <footer>
      <a href="https://discord.gg/jM2AQXtZ" target="_blank">Join AnomicValue Discord</a>
    </footer>
  </div>

  <script>
    // =====================================================================
    // 1) Plugin Chart.js pour fond sombre avant tout dessin
    // =====================================================================
    const bgPlugin = {
      id: 'bgPlugin',
      beforeDraw(chart) {
        const { ctx, width, height } = chart;
        ctx.save();
        ctx.fillStyle = '#1E1F22';  // Couleur de fond fonc√©e
        ctx.fillRect(0, 0, width, height);
        ctx.restore();
      }
    };

    // =====================================================================
    // 2) R√©cup√©ration du param√®tre item
    // =====================================================================
    const params = new URLSearchParams(location.search);
    const item = params.get('item') || params.get('name');
    if (!item) {
      document.getElementById('chart-container').innerHTML =
        '<p style="padding:20px; text-align:center; color:#EEE;">‚ö†Ô∏è Passe <code>?item=NomDeTonItem</code></p>';
      throw '';
    }

    // =====================================================================
    // 3) Injection JSONP vers Apps Script
    // =====================================================================
    const jsonp = document.createElement('script');
    jsonp.src =
      'https://script.google.com/macros/s/AKfycbyX-_XhaZi2M05lP3B67oIxsg9j8oTC0t7VvYHwALlKYCe96ceowiUiwiX6chRwzEwY0Q/exec'
      + '?name=' + encodeURIComponent(item)
      + '&callback=init';
    document.head.appendChild(jsonp);

    let chart, fullData = [];

    // =====================================================================
    // 4) Callback JSONP : on re√ßoit un tableau [{t, v}, ‚Ä¶]
    // =====================================================================
    function init(data) {
      console.log('üöÄ Received data:', data);

      if (data.error) {
        document.getElementById('chart-container').innerHTML =
          `<p style="padding:20px; text-align:center; color:#E66;">‚ùå ${data.error}</p>`;
        return;
      }

      // Formatte en {x: timestamp_ms, y: price}
      fullData = data.map(pt => ({ x: pt.t * 1000, y: pt.v }));

      // ===================================================================
      // 5) Cr√©ation du Chart.js
      // ===================================================================
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: item,
            data: fullData,
            borderColor: '#1FB6FF',
            backgroundColor: 'rgba(31,182,255,0.2)',
            pointRadius: 0,
            tension: 0.2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: { unit: 'month', tooltipFormat: 'MMM YYYY' },
              grid: { color: '#333' },
              ticks: { color: '#CCC' }
            },
            y: {
              grid: { color: '#333' },
              ticks: {
                color: '#CCC',
                callback: v => v.toLocaleString()
              }
            }
          },
          plugins: {
            legend: { labels: { color: '#EEE' } },
            tooltip: { mode: 'index', intersect: false }
          },
          interaction: { mode: 'index', intersect: false }
        },
        plugins: [ bgPlugin ]
      });
    }

    // =====================================================================
    // 6) Gestion des boutons de p√©riode
    // =====================================================================
    document.getElementById('controls').addEventListener('click', e => {
      if (e.target.tagName !== 'BUTTON' || !chart) return;
      document.querySelectorAll('#controls button').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');

      const days = Number(e.target.dataset.range);
      if (days === 0) {
        chart.options.scales.x.min = null;
        chart.options.scales.x.max = null;
      } else {
        const now = Date.now();
        chart.options.scales.x.min = now - days * 24 * 3600 * 1000;
        chart.options.scales.x.max = now;
      }
      chart.update();
    });
  </script>
</body>
</html>
