<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Historique AnomicValue</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    html, body { height:100%; background:#141517; color:#DDD; font-family:sans-serif; }
    #controls {
      display:flex; justify-content:center; gap:8px;
      background:#1E1F22; padding:10px; border-bottom:1px solid #333;
    }
    #controls button {
      background:#2A2C31; border:1px solid #444; border-radius:4px;
      color:#BBB; padding:6px 12px; cursor:pointer; transition:0.2s;
    }
    #controls button.active { background:#5865F2; color:#fff; }
    #controls button:hover { background:#3A3D44; color:#fff; }
    #chart { flex:1; display:flex; justify-content:center; align-items:center; background:#1E1F22; }
    #chart img { max-width:100%; max-height:100%; }
    footer {
      text-align:right; font-size:0.75em;
      padding:6px 12px; background:#1E1F22; border-top:1px solid #333;
    }
    footer a { color:#555; text-decoration:none; }
    footer a:hover { color:#AAA; }
    #container { display:flex; flex-direction:column; height:100%; }
  </style>
</head>
<body>
  <div id="container">
    <div id="controls">
      <button data-range="0" class="active">All</button>
      <button data-range="1">1d</button>
      <button data-range="7">1w</button>
      <button data-range="30">1m</button>
      <button data-range="90">3m</button>
      <button data-range="365">1y</button>
    </div>
    <div id="chart">
      <p style="color:#888;">Chargement…</p>
    </div>
    <footer>
      <a href="https://discord.gg/jM2AQXtZ" target="_blank">Join AnomicValue Discord</a>
    </footer>
  </div>

  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbzyaaDiRnXsKyx5-CwD_XFzPoCswdJoU_yfNLdmvanYPrgrUg_CjLDs8KlIHOLevsiSTg";
    const params  = new URLSearchParams(location.search);
    const item    = params.get('item') || params.get('name');
    const chartEl = document.getElementById('chart');
    if (!item) {
      chartEl.innerHTML = '<p style="padding:20px;color:#EEE;">⚠️ Passe <code>?item=NomDeTonItem</code></p>';
      throw '';
    }

    // Génère l'URL QuickChart avec data-url pointant vers ton Apps Script
    function makeQC(rangeDays) {
      // Config JSON de QuickChart
      const cfg = {
        type: 'line',
        data: { datasets: [{
          label: item,
          // QuickChart va charger data via data-url
          data: { /* vide */ }
        }]},
        options: {
          plugins:{ legend:{ labels:{ color:'#EEE' }}},
          scales:{
            x:{ type:'time', time:{ unit:'day' }, grid:{color:'#333'}, ticks:{color:'#CCC'} },
            y:{ grid:{color:'#333'}, ticks:{color:'#CCC'} }
          },
          layout:{ padding:20 },
          backgroundColor:'#141517'
        }
      };

      // Data-url param : on ajoute &rangeDays pour filtrage côté QuickChart? non, on filtre avant
      const dataUrl = APP_URL + "?name=" + encodeURIComponent(item);

      // On encode :
      return "https://quickchart.io/chart?c=" + encodeURIComponent(JSON.stringify(cfg))
           + "&data-url=" + encodeURIComponent(dataUrl)
           + "&fetch-datasource=true"
           + "&width=800&height=400&devicePixelRatio=2"
           + (rangeDays>0 ? "&cacheSeconds=0&format=png&backgroundColor=%23141A1D&range=" + rangeDays : "");
    }

    // Affiche l'image
    function render(range) {
      document.querySelectorAll('#controls button').forEach(b=>b.classList.toggle('active', Number(b.dataset.range)===range));
      const url = makeQC(range);
      chartEl.innerHTML = `<img src="${url}" alt="Historique ${item}" />`;
    }

    // Boutons
    document.getElementById('controls').addEventListener('click', e=>{
      if (e.target.tagName!=='BUTTON') return;
      render(Number(e.target.dataset.range));
    });

    // Lancement initial
    render(0);
  </script>
</body>
</html>
