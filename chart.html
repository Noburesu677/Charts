<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Historique AnomicValue</title>
  <style>
    html, body { margin:0; padding:0; background:#1e1e1e; color:#fff; }
    #chart { width:100%; height:90vh; }
    #controls { text-align:center; padding:8px; }
    button { margin:0 4px; padding:6px 12px; }
  </style>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <div id="controls">
    <button onclick="setRange(1)">1d</button>
    <button onclick="setRange(7)">1w</button>
    <button onclick="setRange(30)">1m</button>
    <button onclick="setRange(90)">3m</button>
    <button onclick="setRange(365)">1y</button>
    <button onclick="setRange()">All</button>
  </div>
  <div id="chart"></div>
  <script>
    const params = new URLSearchParams(window.location.search);
    const item   = params.get('item') || params.get('name');
    if(!item){
      document.body.innerHTML = '<p style="padding:20px;">Passe ?item=NomDeItem</p>';
      throw '';
    }
    fetch(`https://script.google.com/macros/s/AKfycbz-…/exec?name=${encodeURIComponent(item)}`)
      .then(r=>r.json())
      .then(data=>{
        if(data.error){
          document.body.innerHTML = `<p style="padding:20px;">${data.error}</p>`;
          return;
        }
        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
          layout: { backgroundColor:'#1e1e1e', textColor:'rgba(255,255,255,0.9)' },
          grid: { vertLines:{color:'#333'}, horzLines:{color:'#333'} },
          timeScale:{ timeVisible:true }
        });
        const series = chart.addLineSeries({ color:'cyan', lineWidth:2 });
        series.setData(data);
        window.setRange = days=>{
          if(!days) return chart.timeScale().fitContent();
          const to = chart.timeScale().getVisibleRange().to;
          chart.timeScale().setVisibleRange({ from: to - days*24*3600, to });
        };
      })
      .catch(_=>document.body.innerHTML='<p style="padding:20px;">Erreur réseau</p>');
  </script>
</body>
</html>
